<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PDFService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">roar</a> &gt; <a href="index.source.html" class="el_package">service</a> &gt; <span class="el_source">PDFService.java</span></div><h1>PDFService.java</h1><pre class="source lang-java linenums">package service;

import com.itextpdf.kernel.pdf.PdfDocument;
import com.itextpdf.kernel.pdf.PdfWriter;
import com.itextpdf.layout.Document;
import com.itextpdf.layout.element.Cell;
import com.itextpdf.layout.element.Paragraph;
import com.itextpdf.layout.element.Table;
import com.itextpdf.layout.properties.TextAlignment;
import com.itextpdf.layout.properties.UnitValue;
import entite.Sejour;
import javafx.stage.FileChooser;
import javafx.stage.Stage;
import util.AlertUtil;

import java.io.File;
import java.io.FileNotFoundException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class PDFService {
    
<span class="fc" id="L26">    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy HH:mm&quot;);</span>

    @FunctionalInterface
    public interface FileSelectionStrategy {
        File selectFile(Stage stage, String initialFileName);
    }

    public interface AlertStrategy {
        void showInformation(Stage stage, String title, String content);
        void showError(Stage stage, String title, String content);
    }

    private FileSelectionStrategy fileSelectionStrategy;
    private AlertStrategy alertStrategy;

<span class="nc" id="L41">    public PDFService() {</span>
<span class="nc" id="L42">        this.fileSelectionStrategy = (stage, initialFileName) -&gt; {</span>
<span class="nc" id="L43">            FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L44">            fileChooser.setTitle(&quot;Enregistrer l'analyse des séjours&quot;);</span>
<span class="nc" id="L45">            fileChooser.getExtensionFilters().add(</span>
                    new FileChooser.ExtensionFilter(&quot;PDF Files&quot;, &quot;*.pdf&quot;)
            );
<span class="nc" id="L48">            fileChooser.setInitialFileName(initialFileName);</span>
<span class="nc" id="L49">            return fileChooser.showSaveDialog(stage);</span>
        };

<span class="nc" id="L52">        this.alertStrategy = new AlertStrategy() {</span>
            @Override
            public void showInformation(Stage stage, String title, String content) {
<span class="nc" id="L55">                AlertUtil.showInformation(stage, title, content);</span>
<span class="nc" id="L56">            }</span>

            @Override
            public void showError(Stage stage, String title, String content) {
<span class="nc" id="L60">                AlertUtil.showError(stage, title, content);</span>
<span class="nc" id="L61">            }</span>
        };
<span class="nc" id="L63">    }</span>

<span class="fc" id="L65">    public PDFService(FileSelectionStrategy fileSelectionStrategy, AlertStrategy alertStrategy) {</span>
<span class="fc" id="L66">        this.fileSelectionStrategy = fileSelectionStrategy;</span>
<span class="fc" id="L67">        this.alertStrategy = alertStrategy;</span>
<span class="fc" id="L68">    }</span>
    
    public void generateSejourAnalysisPDF(List&lt;Sejour&gt; sejours, Stage stage) {
<span class="fc" id="L71">        String initialFileName = &quot;analyse_sejours_&quot; + LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd_HHmmss&quot;)) + &quot;.pdf&quot;;</span>
        
<span class="fc" id="L73">        File file = this.fileSelectionStrategy.selectFile(stage, initialFileName);</span>
        
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (file != null) {</span>
            try {
<span class="fc" id="L77">                PdfWriter writer = new PdfWriter(file);</span>
<span class="fc" id="L78">                PdfDocument pdf = new PdfDocument(writer);</span>
<span class="fc" id="L79">                Document document = new Document(pdf);</span>

                // Add title
<span class="fc" id="L82">                Paragraph title = new Paragraph(&quot;Analyse des Séjours&quot;);</span>
<span class="fc" id="L83">                title.setTextAlignment(TextAlignment.CENTER);</span>
<span class="fc" id="L84">                title.setFontSize(20);</span>
<span class="fc" id="L85">                title.setBold();</span>
<span class="fc" id="L86">                document.add(title);</span>

                // Add date
<span class="fc" id="L89">                Paragraph date = new Paragraph(&quot;Généré le: &quot; + LocalDateTime.now().format(DATE_FORMATTER));</span>
<span class="fc" id="L90">                date.setTextAlignment(TextAlignment.CENTER);</span>
<span class="fc" id="L91">                date.setFontSize(12);</span>
<span class="fc" id="L92">                document.add(date);</span>

                // Add space
<span class="fc" id="L95">                document.add(new Paragraph(&quot;\n&quot;));</span>
                
                // Add summary statistics
<span class="fc" id="L98">                addSummaryStatistics(document, sejours);</span>
                
                // Add detailed table
<span class="fc" id="L101">                addDetailedTable(document, sejours);</span>
                
<span class="fc" id="L103">                document.close();</span>
                
<span class="fc" id="L105">                this.alertStrategy.showInformation(stage, &quot;Succès&quot;, &quot;Le PDF a été généré avec succès !&quot;);</span>
<span class="fc" id="L106">            } catch (FileNotFoundException e) {</span>
<span class="fc" id="L107">                this.alertStrategy.showError(stage, &quot;Erreur&quot;, &quot;Erreur lors de la génération du PDF: &quot; + e.getMessage());</span>
<span class="nc" id="L108">            } catch (Exception e) {</span>
<span class="nc" id="L109">                 e.printStackTrace(); </span>
<span class="nc" id="L110">                this.alertStrategy.showError(stage, &quot;Erreur&quot;, &quot;Une erreur inattendue est survenue: &quot; + e.getMessage());</span>
<span class="fc" id="L111">            }</span>
        }
<span class="fc" id="L113">    }</span>
    
    private void addSummaryStatistics(Document document, List&lt;Sejour&gt; sejours) {
        // Calculate statistics
<span class="fc" id="L117">        double totalFrais = 0.0;</span>
<span class="fc" id="L118">        double totalExtras = 0.0;</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">        for (Sejour s : sejours) {</span>
<span class="fc" id="L121">            totalFrais += s.getFraisSejour();</span>
<span class="fc" id="L122">            totalExtras += s.getPrixExtras();</span>
<span class="fc" id="L123">        }</span>

<span class="fc" id="L125">        double totalRevenue = totalFrais + totalExtras;</span>
        
        // Group by type
<span class="fc" id="L128">        Map&lt;String, Long&gt; countByType = new HashMap&lt;String, Long&gt;();</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">        for (Sejour s : sejours) {</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">            String type = s.getTypeSejour() != null ? s.getTypeSejour() : &quot;Non spécifié&quot;;</span>
<span class="fc" id="L131">            countByType.put(type, countByType.getOrDefault(type, 0L) + 1L);</span>
<span class="fc" id="L132">        }</span>
        
        // Group by payment status
<span class="fc" id="L135">        Map&lt;String, Long&gt; countByPaymentStatus = new HashMap&lt;String, Long&gt;();</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (Sejour s : sejours) {</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">            String status = s.getStatutPaiement() != null ? s.getStatutPaiement() : &quot;Inconnu&quot;;</span>
<span class="fc" id="L138">            countByPaymentStatus.put(status, countByPaymentStatus.getOrDefault(status, 0L) + 1L);</span>
<span class="fc" id="L139">        }</span>
        
        // Create summary table
<span class="fc" id="L142">        Table summaryTable = new Table(UnitValue.createPercentArray(2));</span>
<span class="fc" id="L143">        summaryTable.useAllAvailableWidth();</span>

<span class="fc" id="L145">        Cell headerCell = new Cell();</span>
<span class="fc" id="L146">        headerCell.add(new Paragraph(&quot;Statistiques Générales&quot;));</span>
<span class="fc" id="L147">        headerCell.setBold();</span>
<span class="fc" id="L148">        summaryTable.addCell(headerCell);</span>
        
<span class="fc" id="L150">        summaryTable.addCell(new Cell().add(new Paragraph(&quot;&quot;)));</span>
        
<span class="fc" id="L152">        summaryTable.addCell(new Cell().add(new Paragraph(&quot;Nombre total de séjours&quot;)));</span>
<span class="fc" id="L153">        summaryTable.addCell(new Cell().add(new Paragraph(String.valueOf(sejours.size()))));</span>
        
<span class="fc" id="L155">        summaryTable.addCell(new Cell().add(new Paragraph(&quot;Total des frais de séjour&quot;)));</span>
<span class="fc" id="L156">        summaryTable.addCell(new Cell().add(new Paragraph(String.format(&quot;%.2f €&quot;, totalFrais))));</span>
        
<span class="fc" id="L158">        summaryTable.addCell(new Cell().add(new Paragraph(&quot;Total des extras&quot;)));</span>
<span class="fc" id="L159">        summaryTable.addCell(new Cell().add(new Paragraph(String.format(&quot;%.2f €&quot;, totalExtras))));</span>
        
<span class="fc" id="L161">        summaryTable.addCell(new Cell().add(new Paragraph(&quot;Revenu total&quot;)));</span>
<span class="fc" id="L162">        summaryTable.addCell(new Cell().add(new Paragraph(String.format(&quot;%.2f €&quot;, totalRevenue))));</span>
        
<span class="fc" id="L164">        document.add(summaryTable);</span>
<span class="fc" id="L165">        document.add(new Paragraph(&quot;\n&quot;));</span>
        
        // Add type distribution
<span class="fc" id="L168">        Table typeTable = new Table(UnitValue.createPercentArray(2));</span>
<span class="fc" id="L169">        typeTable.useAllAvailableWidth();</span>

<span class="fc" id="L171">        Cell typeHeader = new Cell();</span>
<span class="fc" id="L172">        typeHeader.add(new Paragraph(&quot;Distribution par Type&quot;));</span>
<span class="fc" id="L173">        typeHeader.setBold();</span>
<span class="fc" id="L174">        typeTable.addCell(typeHeader);</span>

<span class="fc" id="L176">        typeTable.addCell(new Cell().add(new Paragraph(&quot;&quot;)));</span>
        
        // Refactoring: Sostituito forEach((k,v) -&gt; ...) con ciclo entrySet
<span class="fc bfc" id="L179" title="All 2 branches covered.">        for (Map.Entry&lt;String, Long&gt; entry : countByType.entrySet()) {</span>
<span class="fc" id="L180">            typeTable.addCell(new Cell().add(new Paragraph(entry.getKey())));</span>
<span class="fc" id="L181">            typeTable.addCell(new Cell().add(new Paragraph(String.valueOf(entry.getValue()))));</span>
<span class="fc" id="L182">        }</span>
        
<span class="fc" id="L184">        document.add(typeTable);</span>
<span class="fc" id="L185">        document.add(new Paragraph(&quot;\n&quot;));</span>
        
        // Add payment status distribution
<span class="fc" id="L188">        Table paymentTable = new Table(UnitValue.createPercentArray(2));</span>
<span class="fc" id="L189">        paymentTable.useAllAvailableWidth();</span>

<span class="fc" id="L191">        Cell paymentHeader = new Cell();</span>
<span class="fc" id="L192">        paymentHeader.add(new Paragraph(&quot;Distribution par Statut de Paiement&quot;));</span>
<span class="fc" id="L193">        paymentHeader.setBold();</span>
<span class="fc" id="L194">        paymentTable.addCell(paymentHeader);</span>

<span class="fc" id="L196">        paymentTable.addCell(new Cell().add(new Paragraph(&quot;&quot;)));</span>
        
<span class="fc bfc" id="L198" title="All 2 branches covered.">        for (Map.Entry&lt;String, Long&gt; entry : countByPaymentStatus.entrySet()) {</span>
<span class="fc" id="L199">            paymentTable.addCell(new Cell().add(new Paragraph(entry.getKey())));</span>
<span class="fc" id="L200">            paymentTable.addCell(new Cell().add(new Paragraph(String.valueOf(entry.getValue()))));</span>
<span class="fc" id="L201">        }</span>
        
<span class="fc" id="L203">        document.add(paymentTable);</span>
<span class="fc" id="L204">        document.add(new Paragraph(&quot;\n&quot;));</span>
<span class="fc" id="L205">    }</span>
    
    private void addDetailedTable(Document document, List&lt;Sejour&gt; sejours) {
<span class="fc" id="L208">        Table table = new Table(UnitValue.createPercentArray(8));</span>
<span class="fc" id="L209">        table.useAllAvailableWidth();</span>
        
        // Add headers
<span class="fc" id="L212">        String[] headers = {&quot;ID&quot;, &quot;Date Entrée&quot;, &quot;Date Sortie&quot;, &quot;Type&quot;, &quot;Frais&quot;, &quot;Extras&quot;, &quot;Paiement&quot;, &quot;Statut&quot;};</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        for (String header : headers) {</span>
<span class="fc" id="L214">            Cell c = new Cell();</span>
<span class="fc" id="L215">            c.add(new Paragraph(header));</span>
<span class="fc" id="L216">            c.setBold();</span>
<span class="fc" id="L217">            table.addHeaderCell(c);</span>
        }
        
        // Add data rows
<span class="fc bfc" id="L221" title="All 2 branches covered.">        for (Sejour sejour : sejours) {</span>
<span class="fc" id="L222">            table.addCell(new Cell().add(new Paragraph(String.valueOf(sejour.getId()))));</span>
            
<span class="fc bfc" id="L224" title="All 2 branches covered.">            String dateEntree = sejour.getDateEntree() != null ? sejour.getDateEntree().format(DATE_FORMATTER) : &quot;&quot;;</span>
<span class="fc" id="L225">            table.addCell(new Cell().add(new Paragraph(dateEntree)));</span>
            
<span class="fc bfc" id="L227" title="All 2 branches covered.">            String dateSortie = sejour.getDateSortie() != null ? sejour.getDateSortie().format(DATE_FORMATTER) : &quot;&quot;;</span>
<span class="fc" id="L228">            table.addCell(new Cell().add(new Paragraph(dateSortie)));</span>
            
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            table.addCell(new Cell().add(new Paragraph(sejour.getTypeSejour() != null ? sejour.getTypeSejour() : &quot;&quot;)));</span>
<span class="fc" id="L231">            table.addCell(new Cell().add(new Paragraph(String.format(&quot;%.2f €&quot;, sejour.getFraisSejour()))));</span>
<span class="fc" id="L232">            table.addCell(new Cell().add(new Paragraph(String.format(&quot;%.2f €&quot;, sejour.getPrixExtras()))));</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">            table.addCell(new Cell().add(new Paragraph(sejour.getMoyenPaiement() != null ? sejour.getMoyenPaiement() : &quot;&quot;)));</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">            table.addCell(new Cell().add(new Paragraph(sejour.getStatutPaiement() != null ? sejour.getStatutPaiement() : &quot;&quot;)));</span>
<span class="fc" id="L235">        }</span>
        
<span class="fc" id="L237">        document.add(table);</span>
<span class="fc" id="L238">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>