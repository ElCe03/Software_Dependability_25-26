<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SalleController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">roar</a> &gt; <a href="index.source.html" class="el_package">controllers</a> &gt; <span class="el_source">SalleController.java</span></div><h1>SalleController.java</h1><pre class="source lang-java linenums">package controllers;

import entite.salle;
import entite.etage;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.HBox;
import javafx.stage.FileChooser;
import javafx.stage.Stage;
import service.EtageService;
import service.SalleService;

import java.io.*;
import java.nio.file.Files;
import java.nio.file.StandardCopyOption;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

<span class="fc" id="L30">public class SalleController {</span>

    // Champs du formulaire
    @FXML
    private TextField nomField;
    @FXML
    private TextField capaciteField;
    @FXML
    private ComboBox&lt;String&gt; typeCombo;
    @FXML
    private ComboBox&lt;String&gt; statusCombo;
    @FXML
    private Spinner&lt;Integer&gt; prioriteSpinner;
    @FXML
    private ComboBox&lt;etage&gt; etageCombo;
    @FXML
    private TextField imageField;
    @FXML
    private ImageView imagePreview;

    // Messages d'erreur
    @FXML
    private Label nomError;
    @FXML
    private Label capaciteError;
    @FXML
    private Label typeError;
    @FXML
    private Label statusError;
    @FXML
    private Label prioriteError;
    @FXML
    private Label etageError;
    @FXML
    private Label imageError;

    // TableView et colonnes
    @FXML
    private TableView&lt;salle&gt; salleTable;
    @FXML
    private TableColumn&lt;salle, String&gt; nomColumn;
    @FXML
    private TableColumn&lt;salle, Integer&gt; capaciteColumn;
    @FXML
    private TableColumn&lt;salle, String&gt; typeColumn;
    @FXML
    private TableColumn&lt;salle, String&gt; statusColumn;
    @FXML
    private TableColumn&lt;salle, Integer&gt; prioriteColumn;
    @FXML
    private TableColumn&lt;salle, etage&gt; etageColumn;
    @FXML
    private TableColumn&lt;salle, String&gt; imageColumn;
    @FXML
    private TableColumn&lt;salle, Void&gt; actionsColumn;

    // Boutons
    @FXML
    private Button saveBtn;
    @FXML
    private Button clearBtn;
    @FXML
    private Button browseBtn;
    @FXML
    private Button exportBtn;

    // Search field
    @FXML
    private TextField searchField;

    // Services et donn√©es
<span class="fc" id="L101">    private final SalleService salleService = new SalleService();</span>
<span class="fc" id="L102">    private final EtageService etageService = new EtageService();</span>
<span class="fc" id="L103">    private final ObservableList&lt;salle&gt; salleData = FXCollections.observableArrayList();</span>
<span class="fc" id="L104">    private final ObservableList&lt;salle&gt; filteredSalleData = FXCollections.observableArrayList();</span>
<span class="fc" id="L105">    private String imagePath = &quot;&quot;;</span>
    public static final String IMAGE_DIR = &quot;src/main/resources/images/&quot;;

    @FXML
    public void initialize() {
<span class="nc" id="L110">        createImageDirectory();</span>
<span class="nc" id="L111">        setupForm();</span>
<span class="nc" id="L112">        setupTable();</span>
<span class="nc" id="L113">        loadSalles();</span>
<span class="nc" id="L114">        setupSearch();</span>
<span class="nc" id="L115">    }</span>

    private void createImageDirectory() {
<span class="nc" id="L118">        File imageDir = new File(IMAGE_DIR);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!imageDir.exists()) {</span>
<span class="nc" id="L120">            imageDir.mkdirs();</span>
        }
<span class="nc" id="L122">    }</span>

    private void setupForm() {
        // Configuration des ComboBox
<span class="nc" id="L126">        typeCombo.setItems(FXCollections.observableArrayList(</span>
                &quot;Consultation&quot;, &quot;Bloc op√©ratoire&quot;, &quot;R√©animation&quot;, &quot;Chambre&quot;));
<span class="nc" id="L128">        statusCombo.setItems(FXCollections.observableArrayList(</span>
                &quot;Disponible&quot;, &quot;Occup√©e&quot;, &quot;En maintenance&quot;));

        // Configuration du Spinner pour la priorit√© (1-10)
<span class="nc" id="L132">        prioriteSpinner.setValueFactory(</span>
                new SpinnerValueFactory.IntegerSpinnerValueFactory(1, 10, 1));

        // Chargement des √©tages
<span class="nc" id="L136">        List&lt;etage&gt; etages = etageService.getAllEtages();</span>
<span class="nc" id="L137">        etageCombo.setItems(FXCollections.observableArrayList(etages));</span>

        // Afficher le num√©ro de l'√©tage dans le ComboBox
<span class="nc" id="L140">        etageCombo.setCellFactory(combo -&gt; new ListCell&lt;etage&gt;() {</span>
            @Override
            protected void updateItem(etage item, boolean empty) {
<span class="nc" id="L143">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L144" title="All 4 branches missed.">                setText(empty || item == null ? &quot;&quot; : String.valueOf(item.getNumero()));</span>
<span class="nc" id="L145">            }</span>
        });
<span class="nc" id="L147">        etageCombo.setButtonCell(new ListCell&lt;etage&gt;() {</span>
            @Override
            protected void updateItem(etage item, boolean empty) {
<span class="nc" id="L150">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">                setText(empty || item == null ? &quot;&quot; : String.valueOf(item.getNumero()));</span>
<span class="nc" id="L152">            }</span>
        });
<span class="nc" id="L154">    }</span>

    private void setupTable() {
        // Configuration des colonnes de donn√©es
<span class="nc" id="L158">        nomColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;nom&quot;));</span>
<span class="nc" id="L159">        capaciteColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;capacite&quot;));</span>
<span class="nc" id="L160">        typeColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;type_salle&quot;));</span>
<span class="nc" id="L161">        statusColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;status&quot;));</span>
<span class="nc" id="L162">        prioriteColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;priorite&quot;));</span>
<span class="nc" id="L163">        etageColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;etage&quot;));</span>
<span class="nc" id="L164">        imageColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;image&quot;));</span>

        // Bind column widths to TableView width for responsiveness
<span class="nc" id="L167">        nomColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.15));</span>
<span class="nc" id="L168">        capaciteColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.1));</span>
<span class="nc" id="L169">        typeColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.15));</span>
<span class="nc" id="L170">        statusColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.15));</span>
<span class="nc" id="L171">        prioriteColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.1));</span>
<span class="nc" id="L172">        etageColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.1));</span>
<span class="nc" id="L173">        imageColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.15));</span>
<span class="nc" id="L174">        actionsColumn.prefWidthProperty().bind(salleTable.widthProperty().multiply(0.15));</span>

        // Configuration de la colonne status
<span class="nc" id="L177">        statusColumn.setCellFactory(column -&gt; new TableCell&lt;salle, String&gt;() {</span>
            @Override
            protected void updateItem(String status, boolean empty) {
<span class="nc" id="L180">                super.updateItem(status, empty);</span>
<span class="nc" id="L181">                setText(null);</span>
<span class="nc" id="L182">                setStyle(&quot;&quot;);</span>

<span class="nc bnc" id="L184" title="All 4 branches missed.">                if (!empty &amp;&amp; status != null) {</span>
<span class="nc" id="L185">                    setText(status);</span>
<span class="nc bnc" id="L186" title="All 4 branches missed.">                    switch (status) {</span>
                        case &quot;Occup√©e&quot;:
<span class="nc" id="L188">                            setStyle(&quot;-fx-text-fill: #EF5350; -fx-background-color: #FFEBEE;&quot;);</span>
<span class="nc" id="L189">                            break;</span>
                        case &quot;Disponible&quot;:
<span class="nc" id="L191">                            setStyle(&quot;-fx-text-fill: #66BB6A; -fx-background-color: #E8F5E9;&quot;);</span>
<span class="nc" id="L192">                            break;</span>
                        case &quot;En maintenance&quot;:
<span class="nc" id="L194">                            setStyle(&quot;-fx-text-fill: #FFCA28; -fx-background-color: #FFF8E1;&quot;);</span>
<span class="nc" id="L195">                            break;</span>
                        default:
<span class="nc" id="L197">                            setStyle(&quot;-fx-text-fill: #333333;&quot;);</span>
                    }
                }
<span class="nc" id="L200">            }</span>
        });

        // Configuration de la colonne image
<span class="nc" id="L204">        imageColumn.setCellFactory(column -&gt; new TableCell&lt;salle, String&gt;() {</span>
<span class="nc" id="L205">            private final ImageView imageView = new ImageView();</span>
<span class="nc" id="L206">            private final Label label = new Label();</span>

            {
<span class="nc" id="L209">                imageView.setFitHeight(40);</span>
<span class="nc" id="L210">                imageView.setFitWidth(40);</span>
<span class="nc" id="L211">                imageView.setPreserveRatio(true);</span>
<span class="nc" id="L212">                label.setStyle(&quot;-fx-text-fill: #666666;&quot;);</span>
<span class="nc" id="L213">            }</span>

            @Override
            protected void updateItem(String imageName, boolean empty) {
<span class="nc" id="L217">                super.updateItem(imageName, empty);</span>

<span class="nc" id="L219">                setGraphic(null);</span>
<span class="nc" id="L220">                setText(null);</span>

<span class="nc bnc" id="L222" title="All 6 branches missed.">                if (!empty &amp;&amp; imageName != null &amp;&amp; !imageName.isEmpty()) {</span>
                    try {
<span class="nc" id="L224">                        File imageFile = new File(IMAGE_DIR + imageName);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                        if (imageFile.exists()) {</span>
<span class="nc" id="L226">                            imageView.setImage(new Image(imageFile.toURI().toString()));</span>
<span class="nc" id="L227">                            setGraphic(imageView);</span>
                        } else {
<span class="nc" id="L229">                            label.setText(&quot;Image manquante&quot;);</span>
<span class="nc" id="L230">                            setGraphic(label);</span>
                        }
<span class="nc" id="L232">                    } catch (Exception e) {</span>
<span class="nc" id="L233">                        label.setText(&quot;Erreur&quot;);</span>
<span class="nc" id="L234">                        setGraphic(label);</span>
<span class="nc" id="L235">                    }</span>
                }
<span class="nc" id="L237">            }</span>
        });

        // Configuration de la colonne d'√©tage
<span class="nc" id="L241">        etageColumn.setCellFactory(column -&gt; new TableCell&lt;salle, etage&gt;() {</span>
            @Override
            protected void updateItem(etage etage, boolean empty) {
<span class="nc" id="L244">                super.updateItem(etage, empty);</span>
<span class="nc bnc" id="L245" title="All 4 branches missed.">                if (empty || etage == null) {</span>
<span class="nc" id="L246">                    setText(null);</span>
                } else {
<span class="nc" id="L248">                    setText(String.valueOf(etage.getNumero()));</span>
                }
<span class="nc" id="L250">            }</span>
        });

        // Configuration de la colonne d'actions
<span class="nc" id="L254">        actionsColumn.setCellFactory(column -&gt; new TableCell&lt;salle, Void&gt;() {</span>
<span class="nc" id="L255">            private final HBox buttons = new HBox(5);</span>
<span class="nc" id="L256">            private final Button editBtn = new Button(&quot;‚úè&quot;);</span>
<span class="nc" id="L257">            private final Button deleteBtn = new Button(&quot;üóë&quot;);</span>

            {
<span class="nc" id="L260">                buttons.setStyle(&quot;-fx-alignment: CENTER;&quot;);</span>
<span class="nc" id="L261">                editBtn.setStyle(&quot;-fx-background-color: #4CAF50; -fx-text-fill: white; -fx-font-size: 12px; -fx-background-radius: 5px;&quot;);</span>
<span class="nc" id="L262">                deleteBtn.setStyle(&quot;-fx-background-color: #EF5350; -fx-text-fill: white; -fx-font-size: 12px; -fx-background-radius: 5px;&quot;);</span>

<span class="nc" id="L264">                editBtn.setOnAction(event -&gt; {</span>
<span class="nc" id="L265">                    salle salle = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L266">                    showEditDialog(salle);</span>
<span class="nc" id="L267">                });</span>

<span class="nc" id="L269">                deleteBtn.setOnAction(event -&gt; {</span>
<span class="nc" id="L270">                    salle salle = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L271">                    confirmAndDelete(salle);</span>
<span class="nc" id="L272">                });</span>

<span class="nc" id="L274">                buttons.getChildren().addAll(editBtn, deleteBtn);</span>
<span class="nc" id="L275">            }</span>

            @Override
            protected void updateItem(Void item, boolean empty) {
<span class="nc" id="L279">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">                if (!empty) {</span>
<span class="nc" id="L281">                    setGraphic(buttons);</span>
                } else {
<span class="nc" id="L283">                    setGraphic(null);</span>
                }
<span class="nc" id="L285">            }</span>
        });
<span class="nc" id="L287">    }</span>

    private void loadSalles() {
<span class="nc" id="L290">        salleData.clear();</span>
<span class="nc" id="L291">        salleData.addAll(salleService.getAll());</span>
<span class="nc" id="L292">        filteredSalleData.setAll(salleData);</span>
<span class="nc" id="L293">        salleTable.setItems(filteredSalleData);</span>
<span class="nc" id="L294">    }</span>

    private void setupSearch() {
<span class="nc" id="L297">        searchField.textProperty().addListener((observable, oldValue, newValue) -&gt; {</span>
<span class="nc" id="L298">            filterSalles(newValue);</span>
<span class="nc" id="L299">        });</span>
<span class="nc" id="L300">    }</span>

    private void filterSalles(String searchText) {
<span class="nc bnc" id="L303" title="All 4 branches missed.">        if (searchText == null || searchText.isEmpty()) {</span>
<span class="nc" id="L304">            filteredSalleData.setAll(salleData);</span>
        } else {
<span class="nc" id="L306">            String lowerCaseFilter = searchText.toLowerCase();</span>
<span class="nc" id="L307">            List&lt;salle&gt; filteredList = salleData.stream()</span>
<span class="nc" id="L308">                    .filter(salle -&gt; {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                        boolean matchesNom = salle.getNom() != null &amp;&amp;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                                salle.getNom().toLowerCase().contains(lowerCaseFilter);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                        boolean matchesType = salle.getType_salle() != null &amp;&amp;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">                                salle.getType_salle().toLowerCase().contains(lowerCaseFilter);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                        boolean matchesStatus = salle.getStatus() != null &amp;&amp;</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                                salle.getStatus().toLowerCase().contains(lowerCaseFilter);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                        boolean matchesEtage = salle.getEtage() != null &amp;&amp;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                                String.valueOf(salle.getEtage().getNumero()).contains(lowerCaseFilter);</span>
<span class="nc bnc" id="L317" title="All 8 branches missed.">                        return matchesNom || matchesType || matchesStatus || matchesEtage;</span>
                    })
<span class="nc" id="L319">                    .collect(Collectors.toList());</span>
<span class="nc" id="L320">            filteredSalleData.setAll(filteredList);</span>
        }
<span class="nc" id="L322">    }</span>

    @FXML
    private void handleExportCSV(ActionEvent event) {
<span class="nc" id="L326">        FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L327">        fileChooser.setTitle(&quot;Exporter les salles en CSV&quot;);</span>
<span class="nc" id="L328">        fileChooser.setInitialFileName(&quot;salles_export.csv&quot;);</span>
<span class="nc" id="L329">        fileChooser.getExtensionFilters().add(</span>
                new FileChooser.ExtensionFilter(&quot;Fichiers CSV&quot;, &quot;*.csv&quot;)
        );

<span class="nc" id="L333">        Stage stage = (Stage) salleTable.getScene().getWindow();</span>
<span class="nc" id="L334">        File file = fileChooser.showSaveDialog(stage);</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (file != null) {</span>
<span class="nc" id="L337">            try (FileWriter writer = new FileWriter(file)) {</span>
                // Write CSV headers
<span class="nc" id="L339">                writer.append(&quot;Nom,Capacit√©,Type,Status,Priorit√©,√âtage,Image\n&quot;);</span>

                // Write data rows
<span class="nc bnc" id="L342" title="All 2 branches missed.">                for (salle s : filteredSalleData) {</span>
<span class="nc" id="L343">                    writer.append(escapeCsvField(s.getNom())).append(&quot;,&quot;);</span>
<span class="nc" id="L344">                    writer.append(String.valueOf(s.getCapacite())).append(&quot;,&quot;);</span>
<span class="nc" id="L345">                    writer.append(escapeCsvField(s.getType_salle())).append(&quot;,&quot;);</span>
<span class="nc" id="L346">                    writer.append(escapeCsvField(s.getStatus())).append(&quot;,&quot;);</span>
<span class="nc" id="L347">                    writer.append(String.valueOf(s.getPriorite())).append(&quot;,&quot;);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                    writer.append(s.getEtage() != null ? String.valueOf(s.getEtage().getNumero()) : &quot;&quot;).append(&quot;,&quot;);</span>
<span class="nc" id="L349">                    writer.append(escapeCsvField(s.getImage())).append(&quot;\n&quot;);</span>
<span class="nc" id="L350">                }</span>

<span class="nc" id="L352">                writer.flush();</span>
<span class="nc" id="L353">                showAlert(&quot;Succ√®s&quot;, &quot;Les donn√©es ont √©t√© export√©es avec succ√®s dans &quot; + file.getAbsolutePath(), Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L354">            } catch (IOException e) {</span>
<span class="nc" id="L355">                showAlert(&quot;Erreur&quot;, &quot;Erreur lors de l'exportation CSV: &quot; + e.getMessage(), Alert.AlertType.ERROR);</span>
<span class="nc" id="L356">            }</span>
        }
<span class="nc" id="L358">    }</span>

    private String escapeCsvField(String field) {
<span class="nc bnc" id="L361" title="All 2 branches missed.">        if (field == null) {</span>
<span class="nc" id="L362">            return &quot;&quot;;</span>
        }
        // Escape commas and quotes in the field
<span class="nc bnc" id="L365" title="All 4 branches missed.">        if (field.contains(&quot;,&quot;) || field.contains(&quot;\&quot;&quot;)) {</span>
<span class="nc" id="L366">            field = field.replace(&quot;\&quot;&quot;, &quot;\&quot;\&quot;&quot;); // Escape quotes by doubling them</span>
<span class="nc" id="L367">            return &quot;\&quot;&quot; + field + &quot;\&quot;&quot;; // Wrap the field in quotes</span>
        }
<span class="nc" id="L369">        return field;</span>
    }

    @FXML
    private void handleBrowseImage(ActionEvent event) {
<span class="nc" id="L374">        FileChooser fileChooser = new FileChooser();</span>
<span class="nc" id="L375">        fileChooser.setTitle(&quot;Choisir une image&quot;);</span>
<span class="nc" id="L376">        fileChooser.getExtensionFilters().addAll(</span>
                new FileChooser.ExtensionFilter(&quot;Images&quot;, &quot;.png&quot;, &quot;.jpg&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;)
        );

<span class="nc" id="L380">        File selectedFile = fileChooser.showOpenDialog(null);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">        if (selectedFile != null) {</span>
            try {
<span class="nc" id="L383">                String fileName = System.currentTimeMillis() + &quot;_&quot; + selectedFile.getName();</span>
<span class="nc" id="L384">                File destFile = new File(IMAGE_DIR + fileName);</span>
<span class="nc" id="L385">                Files.copy(selectedFile.toPath(), destFile.toPath(), StandardCopyOption.REPLACE_EXISTING);</span>

<span class="nc" id="L387">                imagePath = fileName;</span>
<span class="nc" id="L388">                imageField.setText(fileName);</span>
<span class="nc" id="L389">                imagePreview.setImage(new Image(destFile.toURI().toString()));</span>
<span class="nc" id="L390">                imageError.setText(&quot;&quot;);</span>
<span class="nc" id="L391">            } catch (IOException e) {</span>
<span class="nc" id="L392">                showAlert(&quot;Erreur&quot;, &quot;Impossible de charger l'image: &quot; + e.getMessage(), Alert.AlertType.ERROR);</span>
<span class="nc" id="L393">            }</span>
        }
<span class="nc" id="L395">    }</span>

    @FXML
    private void handleSave(ActionEvent event) {
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (!validateForm()) return;</span>

<span class="nc" id="L401">        salle salle = new salle();</span>
<span class="nc" id="L402">        salle.setNom(nomField.getText());</span>
<span class="nc" id="L403">        salle.setCapacite(Integer.parseInt(capaciteField.getText()));</span>
<span class="nc" id="L404">        salle.setType_salle(typeCombo.getValue());</span>
<span class="nc" id="L405">        salle.setStatus(statusCombo.getValue());</span>
<span class="nc" id="L406">        salle.setPriorite(prioriteSpinner.getValue());</span>
<span class="nc" id="L407">        salle.setEtage(etageCombo.getValue());</span>
<span class="nc" id="L408">        salle.setImage(imagePath);</span>

<span class="nc" id="L410">        salleService.addSalle(salle);</span>
<span class="nc" id="L411">        showAlert(&quot;Succ√®s&quot;, &quot;Salle ajout√©e avec succ√®s&quot;, Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L412">        resetForm();</span>
<span class="nc" id="L413">        loadSalles();</span>
<span class="nc" id="L414">    }</span>

    private void showEditDialog(salle salle) {
        // Populate form with salle data
<span class="nc" id="L418">        nomField.setText(salle.getNom());</span>
<span class="nc" id="L419">        capaciteField.setText(String.valueOf(salle.getCapacite()));</span>
<span class="nc" id="L420">        typeCombo.setValue(salle.getType_salle());</span>
<span class="nc" id="L421">        statusCombo.setValue(salle.getStatus());</span>
<span class="nc" id="L422">        prioriteSpinner.getValueFactory().setValue(salle.getPriorite());</span>
<span class="nc" id="L423">        etageCombo.setValue(salle.getEtage());</span>
<span class="nc" id="L424">        imageField.setText(salle.getImage());</span>
<span class="nc" id="L425">        imagePath = salle.getImage();</span>

        // Load image preview
<span class="nc bnc" id="L428" title="All 4 branches missed.">        if (salle.getImage() != null &amp;&amp; !salle.getImage().isEmpty()) {</span>
<span class="nc" id="L429">            File imageFile = new File(IMAGE_DIR + salle.getImage());</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (imageFile.exists()) {</span>
<span class="nc" id="L431">                imagePreview.setImage(new Image(imageFile.toURI().toString()));</span>
            } else {
<span class="nc" id="L433">                imagePreview.setImage(null);</span>
            }
<span class="nc" id="L435">        } else {</span>
<span class="nc" id="L436">            imagePreview.setImage(null);</span>
        }

        // Change save button behavior to update instead of add
<span class="nc" id="L440">        saveBtn.setOnAction(event -&gt; {</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            if (!validateForm()) return;</span>

            // Update salle object
<span class="nc" id="L444">            salle.setNom(nomField.getText());</span>
<span class="nc" id="L445">            salle.setCapacite(Integer.parseInt(capaciteField.getText()));</span>
<span class="nc" id="L446">            salle.setType_salle(typeCombo.getValue());</span>
<span class="nc" id="L447">            salle.setStatus(statusCombo.getValue());</span>
<span class="nc" id="L448">            salle.setPriorite(prioriteSpinner.getValue());</span>
<span class="nc" id="L449">            salle.setEtage(etageCombo.getValue());</span>
<span class="nc" id="L450">            salle.setImage(imagePath);</span>

            // Update in database
<span class="nc" id="L453">            salleService.updateSalle(salle);</span>
<span class="nc" id="L454">            showAlert(&quot;Succ√®s&quot;, &quot;Salle mise √† jour avec succ√®s&quot;, Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L455">            resetForm();</span>
<span class="nc" id="L456">            loadSalles();</span>

            // Restore default save behavior
<span class="nc" id="L459">            saveBtn.setOnAction(this::handleSave);</span>
<span class="nc" id="L460">        });</span>
<span class="nc" id="L461">    }</span>

    private void confirmAndDelete(salle salle) {
<span class="nc" id="L464">        Alert alert = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L465">        alert.setTitle(&quot;Confirmer la suppression&quot;);</span>
<span class="nc" id="L466">        alert.setHeaderText(null);</span>
<span class="nc" id="L467">        alert.setContentText(&quot;Voulez-vous vraiment supprimer la salle &quot; + salle.getNom() + &quot; ?&quot;);</span>

<span class="nc" id="L469">        Optional&lt;ButtonType&gt; result = alert.showAndWait();</span>
<span class="nc bnc" id="L470" title="All 4 branches missed.">        if (result.isPresent() &amp;&amp; result.get() == ButtonType.OK) {</span>
<span class="nc" id="L471">            salleService.deleteSalle(salle.getId());</span>
<span class="nc" id="L472">            showAlert(&quot;Succ√®s&quot;, &quot;Salle supprim√©e avec succ√®s&quot;, Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L473">            loadSalles();</span>
        }
<span class="nc" id="L475">    }</span>

    private void showReservationDialog(salle selectedSalle) {
        try {
<span class="nc" id="L479">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/reservationDialog.fxml&quot;));</span>
<span class="nc" id="L480">            DialogPane dialogPane = loader.load();</span>
<span class="nc" id="L481">            ReservationDialogController controller = loader.getController();</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if (controller == null) {</span>
<span class="nc" id="L483">                showAlert(&quot;Erreur&quot;, &quot;Controller non charg√© pour reservationDialog.fxml&quot;, Alert.AlertType.ERROR);</span>
<span class="nc" id="L484">                return;</span>
            }
<span class="nc" id="L486">            controller.setSalle(selectedSalle);</span>

<span class="nc" id="L488">            Dialog&lt;ButtonType&gt; dialog = new Dialog&lt;&gt;();</span>
<span class="nc" id="L489">            dialog.setDialogPane(dialogPane);</span>
<span class="nc" id="L490">            dialog.setTitle(&quot;R√©server Salle&quot;);</span>

            // Pass the dialog to the controller
<span class="nc" id="L493">            controller.setDialog(dialog);</span>

<span class="nc" id="L495">            Optional&lt;ButtonType&gt; result = dialog.showAndWait();</span>
<span class="nc bnc" id="L496" title="All 4 branches missed.">            if (result.isPresent() &amp;&amp; result.get() == ButtonType.OK) {</span>
<span class="nc" id="L497">                loadSalles(); // Refresh the TableView</span>
            }
<span class="nc" id="L499">        } catch (IOException e) {</span>
<span class="nc" id="L500">            showAlert(&quot;Erreur&quot;, &quot;Erreur lors de l'ouverture de la fen√™tre de r√©servation: &quot; + e.getMessage(), Alert.AlertType.ERROR);</span>
<span class="nc" id="L501">        }</span>
<span class="nc" id="L502">    }</span>

    private boolean validateForm() {
<span class="nc" id="L505">        boolean isValid = true;</span>
<span class="nc" id="L506">        clearErrors();</span>

<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (nomField.getText().isEmpty()) {</span>
<span class="nc" id="L509">            nomError.setText(&quot;Le nom est obligatoire&quot;);</span>
<span class="nc" id="L510">            isValid = false;</span>
        }

<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (capaciteField.getText().isEmpty()) {</span>
<span class="nc" id="L514">            capaciteError.setText(&quot;La capacit√© est obligatoire&quot;);</span>
<span class="nc" id="L515">            isValid = false;</span>
        } else {
            try {
<span class="nc" id="L518">                Integer.parseInt(capaciteField.getText());</span>
<span class="nc" id="L519">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L520">                capaciteError.setText(&quot;Doit √™tre un nombre valide&quot;);</span>
<span class="nc" id="L521">                isValid = false;</span>
<span class="nc" id="L522">            }</span>
        }

<span class="nc bnc" id="L525" title="All 2 branches missed.">        if (typeCombo.getValue() == null) {</span>
<span class="nc" id="L526">            typeError.setText(&quot;Le type est obligatoire&quot;);</span>
<span class="nc" id="L527">            isValid = false;</span>
        }

<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (statusCombo.getValue() == null) {</span>
<span class="nc" id="L531">            statusError.setText(&quot;Le statut est obligatoire&quot;);</span>
<span class="nc" id="L532">            isValid = false;</span>
        }

<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (etageCombo.getValue() == null) {</span>
<span class="nc" id="L536">            etageError.setText(&quot;L'√©tage est obligatoire&quot;);</span>
<span class="nc" id="L537">            isValid = false;</span>
        }

<span class="nc" id="L540">        return isValid;</span>
    }

    private void clearErrors() {
<span class="nc" id="L544">        nomError.setText(&quot;&quot;);</span>
<span class="nc" id="L545">        capaciteError.setText(&quot;&quot;);</span>
<span class="nc" id="L546">        typeError.setText(&quot;&quot;);</span>
<span class="nc" id="L547">        statusError.setText(&quot;&quot;);</span>
<span class="nc" id="L548">        prioriteError.setText(&quot;&quot;);</span>
<span class="nc" id="L549">        etageError.setText(&quot;&quot;);</span>
<span class="nc" id="L550">        imageError.setText(&quot;&quot;);</span>
<span class="nc" id="L551">    }</span>

    @FXML
    private void handleClear(ActionEvent event) {
<span class="nc" id="L555">        resetForm();</span>
<span class="nc" id="L556">    }</span>

    private void resetForm() {
<span class="nc" id="L559">        nomField.clear();</span>
<span class="nc" id="L560">        capaciteField.clear();</span>
<span class="nc" id="L561">        typeCombo.getSelectionModel().clearSelection();</span>
<span class="nc" id="L562">        statusCombo.getSelectionModel().clearSelection();</span>
<span class="nc" id="L563">        prioriteSpinner.getValueFactory().setValue(1);</span>
<span class="nc" id="L564">        etageCombo.getSelectionModel().clearSelection();</span>
<span class="nc" id="L565">        imageField.clear();</span>
<span class="nc" id="L566">        imagePreview.setImage(null);</span>
<span class="nc" id="L567">        imagePath = &quot;&quot;;</span>
<span class="nc" id="L568">        clearErrors();</span>
<span class="nc" id="L569">    }</span>

    private void showAlert(String title, String message, Alert.AlertType alertType) {
<span class="nc" id="L572">        Alert alert = new Alert(alertType);</span>
<span class="nc" id="L573">        alert.setTitle(title);</span>
<span class="nc" id="L574">        alert.setHeaderText(null);</span>
<span class="nc" id="L575">        alert.setContentText(message);</span>
<span class="nc" id="L576">        alert.showAndWait();</span>
<span class="nc" id="L577">    }</span>

    @FXML
    private void showDepartements(ActionEvent event) {
<span class="nc" id="L581">        loadView(&quot;/departement.fxml&quot;, event);</span>
<span class="nc" id="L582">    }</span>

    @FXML
    private void showReservation(ActionEvent event) {
<span class="nc" id="L586">        loadView(&quot;/reservation_list.fxml&quot;, event);</span>
<span class="nc" id="L587">    }</span>

    @FXML
    private void showEtages(ActionEvent event) {
<span class="nc" id="L591">        loadView(&quot;/etage.fxml&quot;, event);</span>
<span class="nc" id="L592">    }</span>

    @FXML
    private void showSalles(ActionEvent event) {
        // Already on salle view
<span class="nc" id="L597">    }</span>

    @FXML
    public void Acceuil(ActionEvent event) {
<span class="nc" id="L601">        loadView(&quot;/interface.fxml&quot;, event);</span>
<span class="nc" id="L602">    }</span>

    private void loadView(String fxmlPath, ActionEvent event) {
        try {
<span class="nc" id="L606">            Parent root = FXMLLoader.load(getClass().getResource(fxmlPath));</span>
<span class="nc" id="L607">            Stage stage = (Stage) ((Node) event.getSource()).getScene().getWindow();</span>
<span class="nc" id="L608">            stage.setScene(new Scene(root));</span>
<span class="nc" id="L609">            stage.show();</span>
<span class="nc" id="L610">        } catch (IOException e) {</span>
<span class="nc" id="L611">            showAlert(&quot;Erreur&quot;, &quot;Impossible de charger la vue: &quot; + fxmlPath, Alert.AlertType.ERROR);</span>
<span class="nc" id="L612">        }</span>
<span class="nc" id="L613">    }</span>

    // Dans SalleController.java
    salle buildSalleFromFields(String nom, String capaciteStr, String type, String status,
                               int priorite, etage etage, String image) {

<span class="pc bpc" id="L619" title="2 of 6 branches missed.">        if (nom == null || nom.isEmpty() ||</span>
<span class="pc bpc" id="L620" title="3 of 8 branches missed.">                capaciteStr == null || capaciteStr.isEmpty() ||</span>
                type == null || status == null || etage == null) {
<span class="fc" id="L622">            throw new IllegalArgumentException(&quot;Champs manquants&quot;);</span>
        }

        int capacite;
        try {
<span class="fc" id="L627">            capacite = Integer.parseInt(capaciteStr);</span>
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">            if (capacite &lt;= 0) throw new NumberFormatException();</span>
<span class="fc" id="L629">        } catch (NumberFormatException e) {</span>
<span class="fc" id="L630">            throw new IllegalArgumentException(&quot;Capacit√© invalide&quot;);</span>
<span class="fc" id="L631">        }</span>

<span class="fc" id="L633">        salle s = new salle();</span>
<span class="fc" id="L634">        s.setNom(nom);</span>
<span class="fc" id="L635">        s.setCapacite(capacite);</span>
<span class="fc" id="L636">        s.setType_salle(type);</span>
<span class="fc" id="L637">        s.setStatus(status);</span>
<span class="fc" id="L638">        s.setPriorite(priorite);</span>
<span class="fc" id="L639">        s.setEtage(etage);</span>
<span class="fc" id="L640">        s.setImage(image);</span>

<span class="fc" id="L642">        return s;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>