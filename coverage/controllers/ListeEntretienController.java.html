<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ListeEntretienController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">roar</a> &gt; <a href="index.source.html" class="el_package">controllers</a> &gt; <span class="el_source">ListeEntretienController.java</span></div><h1>ListeEntretienController.java</h1><pre class="source lang-java linenums">package controllers;

import com.itextpdf.text.*;
import com.itextpdf.text.Font;
import com.itextpdf.text.pdf.PdfPCell;
import com.itextpdf.text.pdf.PdfWriter;
import com.itextpdf.text.pdf.PdfPTable;
import javafx.application.Platform;
import javafx.concurrent.Worker;
import javafx.print.PrinterJob;
import javafx.scene.Group;
import javafx.scene.web.WebView;
import javafx.scene.web.WebEngine;
import javafx.scene.control.Alert;
import javafx.print.PrinterJob;
import javafx.scene.web.WebView;
import javafx.scene.web.WebEngine;
import java.time.LocalDate;


import entite.Entretien;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.Button;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.HBox;
import javafx.scene.web.WebEngine;
import javafx.scene.web.WebView;
import javafx.stage.Modality;
import javafx.stage.Stage;
import service.EntretienService;

import java.awt.*;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.time.LocalDate;

<span class="fc" id="L43">public class ListeEntretienController {</span>

    @FXML
    private TableView&lt;Entretien&gt; entretienTable;

    @FXML
    private TableColumn&lt;Entretien, String&gt; nomColumn;

    @FXML
    private TableColumn&lt;Entretien, LocalDate&gt; dateColumn;

    @FXML
    private TableColumn&lt;Entretien, String&gt; descriptionColumn;

    @FXML
    private TableColumn&lt;Entretien, Void&gt; actionsColumn;

    @FXML
    private TableColumn&lt;Entretien, Void&gt; pdfColumn;

    private EntretienService entretienService;

    private EntretienService getEntretienService() {
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (this.entretienService == null) {</span>
<span class="nc" id="L67">            this.entretienService = new EntretienService();</span>
        }
<span class="nc" id="L69">        return this.entretienService;</span>
    }

    public void setEntretienService(EntretienService entretienService) {
<span class="nc" id="L73">        this.entretienService = entretienService;</span>
<span class="nc" id="L74">    }</span>

    @FXML
    public void initialize() {
<span class="nc" id="L78">        nomColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;nomEquipement&quot;));</span>
<span class="nc" id="L79">        dateColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;date&quot;));</span>
<span class="nc" id="L80">        descriptionColumn.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;description&quot;));</span>

<span class="nc" id="L82">        addActionButtonsToTable();</span>
<span class="nc" id="L83">        addPdfButtonToTable();</span>

<span class="nc" id="L85">        loadEntretienData();</span>
<span class="nc" id="L86">    }</span>

    private void loadEntretienData() {
<span class="nc" id="L89">        entretienTable.getItems().setAll(getEntretienService().getAllEntretiens());</span>
<span class="nc" id="L90">    }</span>

    private void addActionButtonsToTable() {
<span class="nc" id="L93">        actionsColumn.setCellFactory(column -&gt; new TableCell&lt;&gt;() {</span>
<span class="nc" id="L94">            private final Button btnModifier = new Button(&quot;Modifier&quot;);</span>
<span class="nc" id="L95">            private final Button btnSupprimer = new Button(&quot;Supprimer&quot;);</span>
<span class="nc" id="L96">            private final HBox hbox = new HBox(10, btnModifier, btnSupprimer);</span>

            {
<span class="nc" id="L99">                btnModifier.setStyle(&quot;-fx-background-color: #4CAF50; -fx-text-fill: white;&quot;);</span>
<span class="nc" id="L100">                btnSupprimer.setStyle(&quot;-fx-background-color: #F44336; -fx-text-fill: white;&quot;);</span>

<span class="nc" id="L102">                btnModifier.setOnAction(event -&gt; {</span>
<span class="nc" id="L103">                    Entretien entretien = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L104">                    handleModifier(entretien);</span>
<span class="nc" id="L105">                });</span>

<span class="nc" id="L107">                btnSupprimer.setOnAction(event -&gt; {</span>
<span class="nc" id="L108">                    Entretien entretien = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L109">                    handleSupprimer(entretien);</span>
<span class="nc" id="L110">                });</span>
<span class="nc" id="L111">            }</span>

            @Override
            protected void updateItem(Void item, boolean empty) {
<span class="nc" id="L115">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (empty) {</span>
<span class="nc" id="L117">                    setGraphic(null);</span>
                } else {
<span class="nc" id="L119">                    setGraphic(hbox);</span>
                }
<span class="nc" id="L121">            }</span>
        });
<span class="nc" id="L123">    }</span>

    private void addPdfButtonToTable() {
<span class="nc" id="L126">        pdfColumn.setCellFactory(column -&gt; new TableCell&lt;&gt;() {</span>
<span class="nc" id="L127">            private final Button btnGenererPdf = new Button(&quot;G√©n√©rer PDF&quot;);</span>
<span class="nc" id="L128">            private final HBox hbox = new HBox(10, btnGenererPdf);</span>

            {
<span class="nc" id="L131">                btnGenererPdf.setStyle(&quot;-fx-background-color: #2196F3; -fx-text-fill: white;&quot;);</span>
<span class="nc" id="L132">                btnGenererPdf.setOnAction(event -&gt; {</span>
<span class="nc" id="L133">                    Entretien entretien = getTableView().getItems().get(getIndex());</span>
<span class="nc" id="L134">                    handleGenererPdf(entretien);</span>
<span class="nc" id="L135">                });</span>
<span class="nc" id="L136">            }</span>

            @Override
            protected void updateItem(Void item, boolean empty) {
<span class="nc" id="L140">                super.updateItem(item, empty);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (empty) {</span>
<span class="nc" id="L142">                    setGraphic(null);</span>
                } else {
<span class="nc" id="L144">                    setGraphic(hbox);</span>
                }
<span class="nc" id="L146">            }</span>
        });
<span class="nc" id="L148">    }</span>

    private void handleModifier(Entretien entretien) {
        try {
<span class="nc" id="L152">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/ModifierEntretien.fxml&quot;));</span>
<span class="nc" id="L153">            Parent root = loader.load();</span>

<span class="nc" id="L155">            ModifierEntretienController controller = loader.getController();</span>
<span class="nc" id="L156">            controller.initData(entretien);</span>
<span class="nc" id="L157">            controller.setOnEntretienModifie(() -&gt; loadEntretienData());</span>

<span class="nc" id="L159">            Stage stage = new Stage();</span>
<span class="nc" id="L160">            stage.setTitle(&quot;Modifier Entretien&quot;);</span>
<span class="nc" id="L161">            stage.setScene(new Scene(root));</span>
<span class="nc" id="L162">            stage.show();</span>
<span class="nc" id="L163">        } catch (IOException e) {</span>
<span class="nc" id="L164">            System.err.println(&quot;‚ùå Erreur lors du chargement de la page de modification : &quot; + e.getMessage());</span>
<span class="nc" id="L165">        }</span>
<span class="nc" id="L166">    }</span>

    private void handleSupprimer(Entretien entretien) {
<span class="nc" id="L169">        getEntretienService().deleteEntretien(entretien.getId());</span>
<span class="nc" id="L170">        entretienTable.getItems().remove(entretien);</span>
<span class="nc" id="L171">        System.out.println(&quot;üóë Entretien supprim√© : &quot; + entretien.getNomEquipement());</span>
<span class="nc" id="L172">    }</span>

    @FXML
    private void handleGenererPdf(Entretien entretien) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (entretien == null) {</span>
<span class="nc" id="L177">            showAlert(&quot;Erreur&quot;, &quot;L'objet Entretien est null&quot;);</span>
<span class="nc" id="L178">            return;</span>
        }

        try {
            // 1. Create HTML content
<span class="nc" id="L183">            String html = buildHtmlContent(entretien);</span>

            // 2. Create WebView and load content
<span class="nc" id="L186">            WebView webView = new WebView();</span>
<span class="nc" id="L187">            webView.getEngine().loadContent(html);</span>

            // 3. Create and show a temporary stage
<span class="nc" id="L190">            Stage tempStage = new Stage();</span>
<span class="nc" id="L191">            tempStage.initModality(Modality.APPLICATION_MODAL);</span>
<span class="nc" id="L192">            tempStage.setScene(new Scene(new Group(webView)));</span>

            // 4. Properly wait for WebView to render
<span class="nc" id="L195">            webView.getEngine().getLoadWorker().stateProperty().addListener((obs, oldState, newState) -&gt; {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                if (newState == Worker.State.SUCCEEDED) {</span>
                    // 5. Now show the print dialog
<span class="nc" id="L198">                    PrinterJob job = PrinterJob.createPrinterJob();</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">                    if (job != null &amp;&amp; job.showPrintDialog(tempStage)) {</span>
<span class="nc" id="L200">                        boolean success = job.printPage(webView);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                        if (success) {</span>
<span class="nc" id="L202">                            job.endJob();</span>
<span class="nc" id="L203">                            showAlert(&quot;Succ√®s&quot;, &quot;PDF g√©n√©r√© avec succ√®s&quot;);</span>
                        } else {
<span class="nc" id="L205">                            showAlert(&quot;Erreur&quot;, &quot;√âchec de la g√©n√©ration du PDF&quot;);</span>
                        }
                    }
<span class="nc" id="L208">                    tempStage.close();</span>
                }
<span class="nc" id="L210">            });</span>

<span class="nc" id="L212">            tempStage.show(); </span>

<span class="nc" id="L214">        } catch (Exception e) {</span>
<span class="nc" id="L215">            showAlert(&quot;Erreur&quot;, &quot;Erreur lors de la g√©n√©ration du PDF: &quot; + e.getMessage());</span>
<span class="nc" id="L216">            e.printStackTrace();</span>
<span class="nc" id="L217">        }</span>
<span class="nc" id="L218">    }</span>

    // PUBLIC OU PRIVATE peu importe, on utilisera reflection
    private String buildHtmlContent(Entretien entretien) {
<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (entretien == null) throw new NullPointerException();</span>

<span class="fc bfc" id="L224" title="All 2 branches covered.">        String dateStr = (entretien.getDate() != null) ? entretien.getDate().toString() : &quot;Non d√©finie&quot;;</span>

<span class="fc" id="L226">        return &quot;&lt;div class='fiche'&gt;&quot; +</span>
                &quot;&lt;h1&gt;Fiche d'Entretien&lt;/h1&gt;&quot; +
<span class="fc bfc" id="L228" title="All 2 branches covered.">                &quot;&lt;p&gt;√âquipement: &quot; + (entretien.getNomEquipement() != null ? entretien.getNomEquipement() : &quot;&quot;) + &quot;&lt;/p&gt;&quot; +</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">                &quot;&lt;p&gt;Description: &quot; + (entretien.getDescription() != null ? entretien.getDescription() : &quot;&quot;) + &quot;&lt;/p&gt;&quot; +</span>
                &quot;&lt;p&gt;Date: &quot; + dateStr + &quot;&lt;/p&gt;&quot; +
                &quot;&lt;/div&gt;&quot;;
    }

    private void showAlert(String title, String message) {
<span class="nc" id="L235">        Alert alert = new Alert(Alert.AlertType.INFORMATION);</span>
<span class="nc" id="L236">        alert.setTitle(title);</span>
<span class="nc" id="L237">        alert.setHeaderText(null);</span>
<span class="nc" id="L238">        alert.setContentText(message);</span>
<span class="nc" id="L239">        alert.showAndWait();</span>
<span class="nc" id="L240">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>