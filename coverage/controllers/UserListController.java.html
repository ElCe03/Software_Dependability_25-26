<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserListController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">roar</a> &gt; <a href="index.source.html" class="el_package">controllers</a> &gt; <span class="el_source">UserListController.java</span></div><h1>UserListController.java</h1><pre class="source lang-java linenums">package controllers;

import entite.Users;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.chart.BarChart;
import javafx.scene.chart.CategoryAxis;
import javafx.scene.chart.NumberAxis;
import javafx.scene.chart.XYChart;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Priority;
import javafx.scene.layout.Region;
import javafx.scene.layout.VBox;
import service.UserService;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.stage.Stage;
import java.io.IOException;
import java.sql.SQLException;
import java.util.List;
import java.util.stream.Collectors;

<span class="nc" id="L32">public class UserListController {</span>

    @FXML
    private VBox VBoxId;

    @FXML
    private TextField searchInput;

    @FXML
    private ComboBox&lt;String&gt; roleFilter;

    @FXML
    private HBox statsContainer;

    @FXML
    private BarChart&lt;String, Number&gt; statsChart;

<span class="nc" id="L49">    private final UserService userService = new UserService();</span>
<span class="nc" id="L50">    private ObservableList&lt;Users&gt; allUsers = FXCollections.observableArrayList();</span>

    @FXML
    public void initialize() {
        // Charger les utilisateurs au d√©marrage
<span class="nc" id="L55">        chargerUtilisateurs();</span>

        // Ajouter des √©couteurs pour la recherche et le filtrage dynamiques
<span class="nc" id="L58">        searchInput.textProperty().addListener((obs, oldValue, newValue) -&gt; filterUsers());</span>
<span class="nc" id="L59">        roleFilter.valueProperty().addListener((obs, oldValue, newValue) -&gt; filterUsers());</span>

        // Initialiser le BarChart
<span class="nc" id="L62">        statsChart.setBarGap(5);</span>
<span class="nc" id="L63">        statsChart.setCategoryGap(20);</span>
<span class="nc" id="L64">        statsChart.setLegendVisible(true);</span>
<span class="nc" id="L65">        statsChart.setAnimated(true);</span>
<span class="nc" id="L66">    }</span>

    @FXML
    private void ajouterUtilisateur() {
        try {
<span class="nc" id="L71">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/ajouter_utilisateur.fxml&quot;));</span>
<span class="nc" id="L72">            Parent root = loader.load();</span>

<span class="nc" id="L74">            Stage stage = (Stage) VBoxId.getScene().getWindow();</span>
<span class="nc" id="L75">            Scene scene = new Scene(root);</span>
<span class="nc" id="L76">            stage.setScene(scene);</span>
<span class="nc" id="L77">            stage.setTitle(&quot;Ajouter un utilisateur&quot;);</span>
<span class="nc" id="L78">            stage.show();</span>
            // Recharger les utilisateurs apr√®s ajout
<span class="nc" id="L80">            chargerUtilisateurs();</span>
<span class="nc" id="L81">        } catch (IOException e) {</span>
<span class="nc" id="L82">            e.printStackTrace();</span>
<span class="nc" id="L83">            System.err.println(&quot;‚ùå Impossible de charger la vue ajouter_utilisateur.fxml : &quot; + e.getMessage());</span>
<span class="nc" id="L84">        }</span>
<span class="nc" id="L85">    }</span>

    @FXML
    private void deconnexion() {
        try {
<span class="nc" id="L90">            FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/front.fxml&quot;));</span>
<span class="nc" id="L91">            Parent root = loader.load();</span>

<span class="nc" id="L93">            Stage stage = (Stage) VBoxId.getScene().getWindow();</span>
<span class="nc" id="L94">            Scene scene = new Scene(root);</span>
<span class="nc" id="L95">            stage.setScene(scene);</span>
<span class="nc" id="L96">            stage.setTitle(&quot;Connexion&quot;);</span>
<span class="nc" id="L97">            stage.show();</span>
<span class="nc" id="L98">        } catch (IOException e) {</span>
<span class="nc" id="L99">            e.printStackTrace();</span>
<span class="nc" id="L100">            System.err.println(&quot;‚ùå Impossible de charger la vue front.fxml : &quot; + e.getMessage());</span>
<span class="nc" id="L101">        }</span>
<span class="nc" id="L102">    }</span>

    private void chargerUtilisateurs() {
        try {
<span class="nc" id="L106">            List&lt;Users&gt; utilisateurs = userService.listerUtilisateurs();</span>
<span class="nc" id="L107">            allUsers.setAll(utilisateurs);</span>
<span class="nc" id="L108">            filterUsers();</span>
<span class="nc" id="L109">            updateStats();</span>
<span class="nc" id="L110">        } catch (SQLException e) {</span>
<span class="nc" id="L111">            System.err.println(&quot;‚ùå Erreur lors du chargement des utilisateurs : &quot; + e.getMessage());</span>
<span class="nc" id="L112">            showErrorAlert(&quot;Erreur lors du chargement des utilisateurs : &quot; + e.getMessage());</span>
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">    }</span>

    private void filterUsers() {
<span class="nc" id="L117">        String searchText = searchInput.getText().toLowerCase();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        String selectedRole = roleFilter.getValue() != null ? roleFilter.getValue() : &quot;&quot;;</span>

<span class="nc" id="L120">        List&lt;Users&gt; filteredUsers = allUsers.stream()</span>
<span class="nc" id="L121">                .filter(user -&gt; {</span>
                    // Filtre par nom ou pr√©nom
<span class="nc bnc" id="L123" title="All 2 branches missed.">                    boolean matchesSearch = searchText.isEmpty() ||</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">                            (user.getNom() != null &amp;&amp; user.getNom().toLowerCase().contains(searchText)) ||</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">                            (user.getPrenom() != null &amp;&amp; user.getPrenom().toLowerCase().contains(searchText));</span>
                    // Filtre par r√¥le
<span class="nc bnc" id="L127" title="All 2 branches missed.">                    boolean matchesRole = selectedRole.isEmpty() ||</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">                            (user.getRoles() != null &amp;&amp; user.getRoles().contains(selectedRole));</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">                    return matchesSearch &amp;&amp; matchesRole;</span>
                })
<span class="nc" id="L131">                .collect(Collectors.toList());</span>

<span class="nc" id="L133">        listUsersInVBox(filteredUsers);</span>
<span class="nc" id="L134">        updateStats();</span>
<span class="nc" id="L135">    }</span>

    private void updateStats() {
<span class="nc" id="L138">        long total = allUsers.size();</span>
<span class="nc bnc" id="L139" title="All 4 branches missed.">        long patients = allUsers.stream().filter(u -&gt; u.getRoles() != null &amp;&amp; u.getRoles().contains(&quot;ROLE_PATIENT&quot;)).count();</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">        long medecins = allUsers.stream().filter(u -&gt; u.getRoles() != null &amp;&amp; u.getRoles().contains(&quot;ROLE_MEDECIN&quot;)).count();</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">        long pharmaciens = allUsers.stream().filter(u -&gt; u.getRoles() != null &amp;&amp; u.getRoles().contains(&quot;ROLE_PHARMACIEN&quot;)).count();</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">        long staff = allUsers.stream().filter(u -&gt; u.getRoles() != null &amp;&amp; u.getRoles().contains(&quot;ROLE_STAFF&quot;)).count();</span>

<span class="nc" id="L144">        XYChart.Series&lt;String, Number&gt; series = new XYChart.Series&lt;&gt;();</span>
<span class="nc" id="L145">        series.setName(&quot;Utilisateurs&quot;);</span>
<span class="nc" id="L146">        series.getData().add(new XYChart.Data&lt;&gt;(&quot;Patients&quot;, patients));</span>
<span class="nc" id="L147">        series.getData().add(new XYChart.Data&lt;&gt;(&quot;M√©decins&quot;, medecins));</span>
<span class="nc" id="L148">        series.getData().add(new XYChart.Data&lt;&gt;(&quot;Pharmaciens&quot;, pharmaciens));</span>
<span class="nc" id="L149">        series.getData().add(new XYChart.Data&lt;&gt;(&quot;Staff&quot;, staff));</span>

<span class="nc" id="L151">        statsChart.getData().clear();</span>
<span class="nc" id="L152">        statsChart.getData().add(series);</span>

        // Appliquer des styles personnalis√©s aux barres
<span class="nc" id="L155">        String[] colors = {&quot;#28a745&quot;, &quot;#dc3545&quot;, &quot;#ffc107&quot;, &quot;#17a2b8&quot;}; // Vert, Rouge, Jaune, Bleu</span>
<span class="nc" id="L156">        int index = 0;</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (XYChart.Data&lt;String, Number&gt; data : series.getData()) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (data.getNode() != null) {</span>
<span class="nc" id="L159">                data.getNode().setStyle(&quot;-fx-bar-fill: &quot; + colors[index % colors.length] + &quot;;&quot;);</span>
            }
<span class="nc" id="L161">            index++;</span>
<span class="nc" id="L162">        }</span>

        // Mettre √† jour le titre
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (total == 0) {</span>
<span class="nc" id="L166">            statsChart.setTitle(&quot;Aucun utilisateur trouv√©&quot;);</span>
        } else {
<span class="nc" id="L168">            statsChart.setTitle(&quot;R√©partition des utilisateurs par r√¥le (Total: &quot; + total + &quot;)&quot;);</span>
        }
<span class="nc" id="L170">    }</span>

    private void listUsersInVBox(List&lt;Users&gt; users) {
<span class="nc" id="L173">        VBoxId.getChildren().clear();</span>

<span class="nc bnc" id="L175" title="All 2 branches missed.">        for (Users user : users) {</span>
<span class="nc" id="L176">            HBox userBox = new HBox(20);</span>
<span class="nc" id="L177">            userBox.setPadding(new Insets(10));</span>
<span class="nc" id="L178">            userBox.setStyle(&quot;-fx-border-color: #ddd; -fx-border-radius: 8; -fx-background-radius: 8; -fx-background-color: #f9f9f9;&quot;);</span>
<span class="nc" id="L179">            userBox.setAlignment(Pos.CENTER_LEFT);</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">            Label nomLabel = new Label(&quot;üë§ &quot; + (user.getNom() != null ? user.getNom() : &quot;&quot;));</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            Label prenomLabel = new Label(user.getPrenom() != null ? user.getPrenom() : &quot;&quot;);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            Label emailLabel = new Label(&quot;‚úâ &quot; + (user.getEmail() != null ? user.getEmail() : &quot;&quot;));</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            String rolesText = user.getRoles() != null ? String.join(&quot;, &quot;, user.getRoles()) : &quot;&quot;;</span>
<span class="nc" id="L185">            Label roleLabel = new Label(&quot;üîë &quot; + rolesText);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            Label typeLabel = new Label(&quot;üìå &quot; + (user.getType() != null ? user.getType() : &quot;&quot;));</span>

<span class="nc" id="L188">            Button btnModifier = new Button(&quot;‚úè Modifier&quot;);</span>
<span class="nc" id="L189">            btnModifier.setStyle(&quot;-fx-background-color: #0d6efd; -fx-text-fill: white;&quot;);</span>
<span class="nc" id="L190">            btnModifier.setOnAction(e -&gt; {</span>
                try {
<span class="nc" id="L192">                    FXMLLoader loader = new FXMLLoader(getClass().getResource(&quot;/ModifierUtilisateur.fxml&quot;));</span>
<span class="nc" id="L193">                    Parent root = loader.load();</span>
<span class="nc" id="L194">                    ModifierUtilisateurController controller = loader.getController();</span>
<span class="nc" id="L195">                    controller.setUtilisateur(user);</span>
<span class="nc" id="L196">                    Stage stage = (Stage) btnModifier.getScene().getWindow();</span>
<span class="nc" id="L197">                    stage.setScene(new Scene(root));</span>
<span class="nc" id="L198">                    stage.setTitle(&quot;Modifier Utilisateur&quot;);</span>
<span class="nc" id="L199">                    stage.show();</span>
                    // Recharger les utilisateurs apr√®s modification
<span class="nc" id="L201">                    chargerUtilisateurs();</span>
<span class="nc" id="L202">                } catch (IOException ex) {</span>
<span class="nc" id="L203">                    System.err.println(&quot;‚ùå Impossible de charger la vue ModifierUtilisateur.fxml : &quot; + ex.getMessage());</span>
<span class="nc" id="L204">                }</span>
<span class="nc" id="L205">            });</span>

<span class="nc" id="L207">            Button btnSupprimer = new Button(&quot;üóë Supprimer&quot;);</span>
<span class="nc" id="L208">            btnSupprimer.setStyle(&quot;-fx-background-color: #dc3545; -fx-text-fill: white;&quot;);</span>
<span class="nc" id="L209">            btnSupprimer.setOnAction(e -&gt; {</span>
                try {
<span class="nc" id="L211">                    userService.supprimer(user.getId());</span>
<span class="nc" id="L212">                    chargerUtilisateurs();</span>
<span class="nc" id="L213">                } catch (SQLException ex) {</span>
<span class="nc" id="L214">                    System.err.println(&quot;‚ùå √âchec de la suppression : &quot; + ex.getMessage());</span>
<span class="nc" id="L215">                }</span>
<span class="nc" id="L216">            });</span>

<span class="nc" id="L218">            Region spacer = new Region();</span>
<span class="nc" id="L219">            HBox.setHgrow(spacer, Priority.ALWAYS);</span>

<span class="nc" id="L221">            userBox.getChildren().addAll(nomLabel, prenomLabel, emailLabel, roleLabel, typeLabel, spacer, btnModifier, btnSupprimer);</span>
<span class="nc" id="L222">            VBoxId.getChildren().add(userBox);</span>
<span class="nc" id="L223">        }</span>
<span class="nc" id="L224">    }</span>

    private void showErrorAlert(String message) {
<span class="nc" id="L227">        Alert alert = new Alert(Alert.AlertType.ERROR);</span>
<span class="nc" id="L228">        alert.setTitle(&quot;Erreur&quot;);</span>
<span class="nc" id="L229">        alert.setHeaderText(null);</span>
<span class="nc" id="L230">        alert.setContentText(message);</span>
<span class="nc" id="L231">        alert.showAndWait();</span>
<span class="nc" id="L232">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>